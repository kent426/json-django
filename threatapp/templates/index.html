<!DOCTYPE html>
<html lang="en">
<head>

  {% block title %}<title>Local Library</title>{% endblock %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- jquery -->
  {% load static %}
  <script rel="text/javascript" src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
  <!-- jquery ui -->
  {% load static %}
  <script rel="text/javascript" src="{% static 'js/moment.min.js' %}"></script>

  {% load static %}
  <script rel="text/javascript" src="{% static 'js/jquery-ui.min.js' %}"></script>

  <!-- lodash  for  json deep comparsion -->
  <script src ="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
  <!-- tabulator for table displaying -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.3.2/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.3.2/js/tabulator.min.js"></script>

  
  <!-- Add additional CSS in static file -->
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body>
  <h3 class=" text-center">Metafile Record Table</h3>

 
          <select class="form-control " id="period-select" style="width: 10%; float: right;">
            <option value="0" >24 Hours</option>
            <option value="1">7 Days</option>
            <option value="2">4 Weeks</option>
          </select>          

        
  <div id="threat-table" style="clear: both;"> </div>
</body>
</html>
<script type="text/javascript">

  function DataManager(api0,api1,api2) {
    this.fetched_data = []
    this.current_mode = 0
    this.current_data = []
    this.displayed_data = []
    this.currentapi = api0
    this.api0 = api0
    this.api1 = api1
    this.api2 = api2

    this.firstTimeLoad = true
    this.ajaxing = false
    this.select_reload = false

    this.start_service = function() {
      this.init_data()
      //retrieve and render table
      this.start_polling()
    }

    this.init_data = function() {
      this.current_mode = 0
      this.currentapi = this.api0
      
    }

    // user drop down respond func
    this.choose_period = function(arg) {
      this.select_reload = true
      if(arg == 0)
        this.currentapi = this.api0
      else if(arg == 1 ) 
        this.currentapi = this.api1
      else
        this.currentapi = this.api2
    }

    this.is_latest = function(cur_data, server_data) {
      //Performs a deep comparison between two values to determine if they are equivalent.
      //From https://lodash.com/docs/4.17.4#isEqual.
      return _.isEqual(cur_data, server_data)
    } 

    this.render_popup = function(js_data) {
      if (confirm("Update detected changes?") == true) {
          this.confirm_popup(js_data)
      } else {
          this.dismiss_popup()
      }

    }

    this.confirm_popup = function (js_data) {
      this.render_table_data(js_data)
    }

    this.dismiss_popup = function() {
      return
    }



    this.setup_init_table = function() {
      var level_sort_helper_dict = {"malicious": 5,"Malicious": 5,
                                    "high-risk": 4, "High-Risk": 4,
                                    "medium-risk": 3, "Medium-Risk":3,
                                    "low-risk": 2,"Low-Risk": 2,
                                    "clean": 1, "Clean": 1
                                  };

      $("#threat-table").tabulator({
        selectable:false,
        responsiveLayout : true, 
        height:"100%",// set height of table, this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
          layout:"fitColumns", //fit columns to width of table (optional)
          responsiveLayout:true,
          initialSort:[
              {column:"rating", dir:"desc"}, //sort by rating 
          ],
          columns:[ //Define Table Columns
              {title:"File Name", field:"filename",align:"center"},
              {title:"Rating", field:"rating",align:"center", sorter:function(a, b){
                return level_sort_helper_dict[a]- level_sort_helper_dict[b] ;} },
              {title:"Action", field:"action", align:"center"},
              {title:"Submit-Type", field:"submit-type",align:"center"},
              {title:"Date", field:"date", sorter:"date",sorterParams:{format:"MMM DD, YYYY HH:MM:SS"}, align:"center"},
          ],
        rowFormatter:function(row){
        //row - row component

          var data = row.getData();
          switch(data.rating) {
              case "malicious":
              case "Malicious":
                  row.getElement().css({"background-color":"Red"})
                  break;
              case "high-risk":
              case "High-Risk":
                  row.getElement().css({"background-color":"Orange"})
                  break;
              case "medium-risk":
              case "Medium-Risk":
                  row.getElement().css({"background-color":"LightSalmon"})
                  break;
              case "low-risk":
              case "Low-Risk":
                  row.getElement().css({"background-color":"LightGoldenRodYellow"})
                  break;
              case "clean":
              case "Clean":
                  row.getElement().css({"background-color":"LightCyan"})
                  break;
              default:
                  row.getElement().css({"background-color":"white"})
          }

        },
      });

    }

    this.render_table_data = function(js_data) {
      //load sample data into the table
      //$("#threat-table").html("")
      $("#threat-table").tabulator("clearData");
      that.displayed_data = JSON.parse(JSON.stringify(js_data))
      $("#threat-table").tabulator("setData", js_data);
      $("#threat-table").tabulator("setSort", "rating", "desc");

      $(".tabulator-col-title").css("text-align","center")
      // //reset cell height
      // $(".tabulator-row").css("height","50px")
      // $(".tabulator-cell").css("height","50px")

      // // //center the text in table cells
      // $(".tabulator-cell").css("display","table-cell")
      // $(".tabulator-cell").css("vertical-align","middle")
      //$(".tabulator-tableHolder").css("background","white")

    }

    this.start_polling = function poll() {
      that = this

      setInterval(function() {
        console.log(that.ajaxing)
        if(that.ajaxing) {
          return
        }
        console.log("ajax start")
        that.ajaxing = true 
        $.ajax({
          url : that.currentapi, // the endpoint,commonly same url
          type : "GET", // http method
  // data sent with the post request

  //  // handle a successful response
          success : function(json) {
            console.log(json); // another sanity check
    //On success show the data posted to server as a message
            // console.log(that.is_latest(that.current_data,json))

            if(!that.is_latest(that.current_data,json)) {
              that.current_data = JSON.parse(JSON.stringify(json))

              if(that.firstTimeLoad) {
                that.firstTimeLoad = false
                that.setup_init_table()
                that.displayed_data = JSON.parse(JSON.stringify(json))
                that.render_table_data(json)
                console.log("first time")
              }


              if(that.select_reload) {
                that.render_table_data(json) 
                that.select_reload = false         
              } else {
                that.render_popup(json)
                console.log(" not first time")
              }
            }

            console.log("here ajaxing")
            console.log(this.url)
          },

          //  // handle a non-successful response
          error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
          complete: function() {
            that.ajaxing = false
            console.log("ajax complete")
          },
          timeout:2000

        });
      },1000)


    }
  }



  $(document).ready(function(){


    var base = window.location.protocol + "//" + window.location.host
    var api0 = base + "{% url 'getmeta' 0 %}"
    var api1 = base + "{% url 'getmeta' 1 %}"
    var api2 = base + "{% url 'getmeta' 2 %}"

    dataManager = new DataManager(api0,api1,api2)
    dataManager.start_service()

    $('#period-select').on('change', function() {
      dataManager.choose_period(this.value)
    })
    console.log(base)
    console.log(api0)

    console.log("hello")

  //For doing AJAX post

// //When submit is clicked
$(".ptype").click(function(e) {

// //Prevent default submit. Must for Ajax post.Beginner's pit.
e.preventDefault();


// //This is the Ajax post.Observe carefully. It is nothing but details of where_to_post,what_to_post
// //Send data  


});
});
</script>